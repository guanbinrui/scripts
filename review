#!/usr/bin/env bash

set -e

REPOS=(
  "Dimensiondev/firefly-social"
  "Dimensiondev/firefly-wallet"
  "Dimensiondev/firefly-chatbot"
  "Dimensiondev/firefly-sitemap"
  "Dimensiondev/firefly-workers"
  "Dimensiondev/firefly-about"
  "Dimensiondev/firefly-exception-tracker"
  "Dimensiondev/firefly-bb8-bot"
)

# ----- fzf (ESC must NOT kill script) -----
trap '' INT
set +e

while true; do
  echo
  echo "Fetching PRs from all repositories..."
  echo

  ALL_PRS=""
  for repo in "${REPOS[@]}"; do
    PRS=$(gh pr list \
      --repo "$repo" \
      --state open \
      --limit 200 \
      --json number,title,author,isDraft,reviewDecision,mergeable,createdAt)

    [[ "$PRS" == "[]" ]] && continue

    PRS_WITH_REPO=$(echo "$PRS" | jq --arg repo "$repo" '
      .[] | . + { repo: $repo }
    ')

    ALL_PRS+="$PRS_WITH_REPO"$'\n'
  done

  if [[ -z "$ALL_PRS" ]]; then
    echo "No open PRs found."
    break
  fi

  PR_LIST=$(echo "$ALL_PRS" | jq -rs '
    sort_by(.createdAt) | reverse | .[] |
    "\(.repo)\t#\(.number)\t" +
    (if .isDraft then "DRAFT " else "READY " end) + "\t" +
    (if .reviewDecision == "APPROVED" then "âœ”ï¸  "
     elif .reviewDecision == "CHANGES_REQUESTED" then "âŒ  "
     else "â³  " end) + "\t" +
    (if .mergeable == "MERGEABLE" then "MERGEABLE"
     elif .mergeable == "CONFLICTING" then "CONFLICT "
     else "UNKNOWN  " end) + "\t@" +
    .author.login + "\t" +
    .title
  ')

  echo
  echo "Select PRs to review (across all repos)"
  echo "TAB = select | ENTER = review | ESC = skip all"
  echo

  SELECTED=$(echo "$PR_LIST" | fzf \
    --multi \
    --ansi \
    --prompt="PRs > " \
    --header="repo | # | READY | review | merge | author | title")

  FZF_EXIT=$?

  if [[ $FZF_EXIT -ne 0 || -z "$SELECTED" ]]; then
    echo "â­ï¸  No PRs selected. Exiting."
    break
  fi

  # Process selected PRs: show decision menu first, then act (one PR then back to menu)
  while IFS=$'\t' read -r repo pr status review merge author title; do
    pr_number="${pr#\#}"

    echo
    echo "--------------------------------"
    echo "$repo PR #$pr_number"
    echo "--------------------------------"
    echo
    echo "Decision (arrows to select, Enter to confirm):"
    echo

    DECISION_MENU="1) Approve
2) Approve and squash
3) Review in web
4) Review in CLI
5) Close PR
6) Back"
    choice_line=$(echo "$DECISION_MENU" | fzf --prompt="Decision > " --no-multi)
    [[ -z "$choice_line" ]] && choice=6 || choice="${choice_line:0:1}"

    case "$choice" in
      1)
        gh pr review "$pr_number" --repo "$repo" --approve
        echo "âœ… Approved"
        break
        ;;
      2)
        gh pr review "$pr_number" --repo "$repo" --approve
        gh pr merge "$pr_number" --repo "$repo" --squash
        echo "ðŸš€ Approved and merged"
        break
        ;;
      3)
        gh pr view "$pr_number" --repo "$repo" --web
        break
        ;;
      4)
        gh pr view "$pr_number" --repo "$repo" \
          --json title,author,headRefName,baseRefName \
          --jq '"Title: \(.title)\nAuthor: \(.author.login)\nBranch: \(.headRefName) â†’ \(.baseRefName)"'
        echo
        gh pr diff "$pr_number" --repo "$repo"
        break
        ;;
      5)
        read -p "Confirm close PR? (y/N): " confirm </dev/tty
        [[ "$confirm" =~ ^[Yy]$ ]] && gh pr close "$pr_number" --repo "$repo"
        break
        ;;
      6)
        echo "â­ï¸  Back to selection menu..."
        break
        ;;
      *)
        echo "Invalid choice, skipped"
        ;;
    esac
  done <<< "$SELECTED"

  # After processing (any action or Back), return to selection menu
  continue
done

set -e
trap - INT

echo
echo "ðŸŽ‰ Unified PR review finished"

