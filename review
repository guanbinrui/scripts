#!/usr/bin/env bash

set -e

REPOS=(
  "Dimensiondev/firefly-social"
  "Dimensiondev/firefly-wallet"
  "Dimensiondev/firefly-chatbot"
  "Dimensiondev/firefly-sitemap"
  "Dimensiondev/firefly-workers"
  "Dimensiondev/firefly-about"
  "Dimensiondev/firefly-exception-tracker"
  "Dimensiondev/firefly-bb8-bot"
  "Dimensiondev/firefly-prophet"
)

# ----- fzf (ESC must NOT kill script) -----
trap '' INT
set +e

while true; do
  echo
  echo "Fetching PRs from all repositories..."
  echo

  ALL_PRS=""
  for repo in "${REPOS[@]}"; do
    PRS=$(gh pr list \
      --repo "$repo" \
      --state open \
      --limit 200 \
      --json number,title,author,isDraft,reviewDecision,mergeable,createdAt)

    [[ "$PRS" == "[]" ]] && continue

    PRS_WITH_REPO=$(echo "$PRS" | jq --arg repo "$repo" '
      .[] | . + { repo: $repo }
    ')

    ALL_PRS+="$PRS_WITH_REPO"$'\n'
  done

  if [[ -z "$ALL_PRS" ]]; then
    echo "No open PRs found."
    break
  fi

  # ANSI colors: green, red, gray, reset (for --ansi fzf)
  G=$'\e[32m'
  R=$'\e[31m'
  X=$'\e[90m'
  Z=$'\e[0m'

  PR_LIST=$(echo "$ALL_PRS" | jq -rs --arg G "$G" --arg R "$R" --arg X "$X" --arg Z "$Z" '
    sort_by(.createdAt) | reverse | .[] |
    "\(.repo)\t#\(.number)\t" +
    (if .isDraft then $X + "DRAFT" + $Z + " " else $G + "READY" + $Z + " " end) + "\t" +
    (if .reviewDecision == "APPROVED" then "‚úîÔ∏è  "
     elif .reviewDecision == "CHANGES_REQUESTED" then "‚ùå  "
     else "‚è≥  " end) + "\t" +
    (if .mergeable == "MERGEABLE" then $G + "MERGEABLE" + $Z
     elif .mergeable == "CONFLICTING" then $R + "CONFLICT" + $Z + " "
     else $X + "UNKNOWN" + $Z + "  " end) + "\t@" +
    .author.login + "\t" +
    .title
  ')

  # Append operation items so fzf starts with first PR selected
  REFRESH_LINE=$'‚ü≥ Refresh'
  PR_LIST=$(printf '%s\n%s' "$REFRESH_LINE" "$PR_LIST")

  echo
  echo "Select PRs to review (across all repos)"
  echo "TAB = select | ENTER = review | ESC = skip all"
  echo

  SELECTED=$(echo "$PR_LIST" | fzf \
    --multi \
    --ansi \
    --prompt="PRs > " \
    --header="repo | # | READY | review | merge | author | title")

  FZF_EXIT=$?

  if [[ $FZF_EXIT -ne 0 || -z "$SELECTED" ]]; then
    echo "‚è≠Ô∏è  No PRs selected. Exiting."
    break
  fi

  # Handle operation items: refresh
  do_refresh=0
  PR_LINES=""
  while IFS= read -r line; do
    [[ -z "$line" ]] && continue
    if [[ "$line" == "$REFRESH_LINE" ]]; then
      do_refresh=1
    else
      PR_LINES+="$line"$'\n'
    fi
  done <<< "$SELECTED"

  if (( do_refresh )); then
    continue
  fi
  if [[ -z "$PR_LINES" ]]; then
    continue
  fi

  # Process selected PRs: show decision menu first, then act (one PR then back to menu)
  while IFS=$'\t' read -r repo pr status review merge author title; do
    [[ -z "$repo" ]] && continue
    pr_number="${pr#\#}"

    echo
    echo "--------------------------------"
    echo "$repo PR #$pr_number"
    echo "--------------------------------"
    echo
    echo "Decision (arrows to select, Enter to confirm):"
    echo

    DECISION_MENU="1) Approve
2) Approve and squash
3) Review in web
4) Review in CLI
5) Close PR
6) Back"
    choice_line=$(echo "$DECISION_MENU" | fzf --prompt="Decision > " --no-multi)
    [[ -z "$choice_line" ]] && choice=6 || choice="${choice_line:0:1}"

    case "$choice" in
      1)
        gh pr review "$pr_number" --repo "$repo" --approve
        echo "‚úÖ Approved"
        break
        ;;
      2)
        gh pr review "$pr_number" --repo "$repo" --approve
        gh pr merge "$pr_number" --repo "$repo" --squash
        echo "üöÄ Approved and merged"
        break
        ;;
      3)
        gh pr view "$pr_number" --repo "$repo" --web
        break
        ;;
      4)
        gh pr view "$pr_number" --repo "$repo" \
          --json title,author,headRefName,baseRefName \
          --jq '"Title: \(.title)\nAuthor: \(.author.login)\nBranch: \(.headRefName) ‚Üí \(.baseRefName)"'
        echo
        gh pr diff "$pr_number" --repo "$repo"
        break
        ;;
      5)
        read -p "Confirm close PR? (y/N): " confirm </dev/tty
        [[ "$confirm" =~ ^[Yy]$ ]] && gh pr close "$pr_number" --repo "$repo"
        break
        ;;
      6)
        echo "‚è≠Ô∏è  Back to selection menu..."
        break
        ;;
      *)
        echo "Invalid choice, skipped"
        ;;
    esac
  done <<< "$PR_LINES"

  # After processing (any action or Back), return to selection menu
  continue
done

set -e
trap - INT

echo
echo "üéâ Unified PR review finished"

